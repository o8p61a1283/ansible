---
- hosts: localhost
  become: yes
  gather_facts: no
 
  tasks:
  - name: compress the directory
    archive: 
      path: /opt/tomcat
      dest: /var/tomcat/tomcat-{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}.tar.gz
      format: gz

- hosts: postgres
  become: yes
  gather_facts: no

  tasks:
  - name: Transfer file from localhost to postgres
    copy:
        src: /var/tomcat/
        dest: /tmp/

- hosts: localhost
  become: yes
  gather_facts: no

  tasks:
  - name: delete the file before 2 days
    find: 
      paths: /var/tomcat/
      age: 2d
    register: files_to_delete
